image: golang:1.14
stages:
  - init
  - test
  - build
  - release
  - package
  - publish

init:
  stage: init
  image: usvc/ci:go-dependencies
  cache:
    key: ${CI_PROJECT_REF}_${CI_COMMIT_REF_NAME}
    paths: ["./vendor"]
  artifacts:
    paths: ["./vendor"]
  script: ["entrypoint"]

unit test:
  stage: test
  image: usvc/ci:go-test
  dependencies: ["init"]
  artifacts:
    paths: ["./c.out"]
  script: ["entrypoint"]

.build:
  image: usvc/ci:go-build-production
  dependencies: ["init"]
  artifacts:
    paths: ["./bin/*"]
  variables:
    CMD_ROOT: semver
  before_script: ["git fetch"]
  script: ["entrypoint"]
.build_linux:
  extends: .build
  variables:
    GOOS: linux
    GOARCH: amd64
.build_macos:
  extends: .build
  variables:
    GOOS: darwin
    GOARCH: amd64
.build_windows:
  extends: .build
  variables:
    GOOS: windows
    GOARCH: "386"
build linux (test):
  extends: .build_linux
  stage: test
  only: ["master"]
build macos (test):
  extends: .build_macos
  stage: test
  only: ["master"]
build windows (test):
  extends: .build_windows
  stage: test
  only: ["master"]
build linux:
  extends: .build_linux
  stage: build
  only: ["tags"]
build macos:
  extends: .build_macos
  stage: build
  only: ["tags"]
build windows:
  extends: .build_windows
  stage: build
  only: ["tags"]

version bump:
  stage: release
  only:
    - master
  image: usvc/semver:gitlab-latest
  before_script:
    - apk update && apk upgrade
    - apk add openssh
    - mkdir -p ~/.ssh
    - 'printf -- "${DEPLOY_KEY}" | base64 -d > ~/.ssh/id_rsa'
    - chmod 600 -R ~/.ssh/id_rsa
    - ssh-keyscan -t rsa gitlab.com >> ~/.ssh/known_hosts
  script:
    - git remote set-url origin "git@gitlab.com:${CI_PROJECT_PATH}.git"
    - git checkout master
    - git fetch
    - semver bump --git --apply
    - git push origin master --verbose --tags
  after_script:
    - rm -rf ~/.ssh/*

compress:
  stage: package
  only: ["tags"]
  # allow failure because it's not necessary to always compress
  # even though that would be nice
  allow_failure: true
  dependencies: ["build linux", "build macos", "build windows"]
  artifacts:
    expire_in: 1 day
    paths: ["./bin/*"]
  before_script:
    - apt-get update && apt-get upgrade -y
    - apt-get install -y make g++ upx
  script:
    - GOOS=linux GOARCH=amd64 make compress_production
    - GOOS=darwin GOARCH=amd64 make compress_production
    - GOOS=windows GOARCH=386 BIN_EXT=.exe make compress_production

dockerize:
  stage: package
  only: ["tags"]
  services: ["docker:19.03.1-dind"]
  image: usvc/ci:docker-build
  artifacts:
    paths: ["./build/*"]
  variables:
    IMAGE_URL: usvc/libeg-config:latest
    OUTPUT_PATH: ./build/config.tar.gz
  script:
    - mkdir -p ./build
    - entrypoint

dockerhub:
  stage: publish
  services:
    - docker:19.03.1-dind
  image: docker:19.03.1
  dependencies:
    - dockerize
  only:
    - tags
  before_script:
    - apk add git jq make
    - docker login ${DOCKER_REGISTRY_URL:-docker.io} -u ${DOCKER_REGISTRY_USERNAME} -p ${DOCKER_REGISTRY_PASSWORD}
  script:
    - make load
    - make dockerhub
  after_script:
    - docker logout
    - rm -rf ~/.docker/config.json
